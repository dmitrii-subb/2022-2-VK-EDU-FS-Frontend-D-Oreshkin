(()=>{var e,t,s,n,c=Object.create,a=Object.defineProperty,h=Object.getOwnPropertyDescriptor,l=Object.getOwnPropertyNames,r=Object.getOwnPropertySymbols,u=Object.getPrototypeOf,_=Object.prototype.hasOwnProperty,i=Object.prototype.propertyIsEnumerable,o=(e,t,s)=>t in e?a(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s,d=(e,t)=>{for(var s in t=t||{})_.call(t,s)&&o(e,s,t[s]);if(r)for(var s of r(t))i.call(t,s)&&o(e,s,t[s]);return e},p=(e,t,s)=>{s=null!=e?c(u(e)):{};var n=!t&&e&&e.__esModule?s:a(s,"default",{value:e,enumerable:!0}),r=e,i=void 0,o=void 0;if(r&&"object"==typeof r||"function"==typeof r)for(let e of l(r))_.call(n,e)||e===i||a(n,e,{get:()=>r[e],enumerable:!(o=h(r,e))||o.enumerable});return n},b=(e,o,c)=>new Promise((t,s)=>{var n=e=>{try{i(c.next(e))}catch(e){s(e)}},r=e=>{try{i(c.throw(e))}catch(e){s(e)}},i=e=>e.done?t(e.value):Promise.resolve(e.value).then(n,r);i((c=c.apply(e,o)).next())}),f=(e=(e,t)=>{"use strict";var s="object"==typeof Reflect?Reflect:null,a=s&&"function"==typeof s.apply?s.apply:function(e,t,s){return Function.prototype.apply.call(e,t,s)};var n=s&&"function"==typeof s.ownKeys?s.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)},r=Number.isNaN||function(e){return e!=e};function i(){i.init.call(this)}t.exports=i,t.exports.once=function(c,a){return new Promise(function(e,t){function s(e){c.removeListener(a,n),t(e)}function n(){"function"==typeof c.removeListener&&c.removeListener("error",s),e([].slice.call(arguments))}var r,i,o;b(c,a,n,{once:!0}),"error"!==a&&(i=s,o={once:!0},"function"==typeof(r=c).on&&b(r,"error",i,o))})},(i.EventEmitter=i).prototype._events=void 0,i.prototype._eventsCount=0,i.prototype._maxListeners=void 0;var o=10;function h(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function c(e){return void 0===e._maxListeners?i.defaultMaxListeners:e._maxListeners}function l(e,t,s,n){var r,i;return h(s),void 0===(r=e._events)?(r=e._events=Object.create(null),e._eventsCount=0):(void 0!==r.newListener&&(e.emit("newListener",t,s.listener||s),r=e._events),i=r[t]),void 0===i?(i=r[t]=s,++e._eventsCount):("function"==typeof i?i=r[t]=n?[s,i]:[i,s]:n?i.unshift(s):i.push(s),0<(r=c(e))&&i.length>r&&!i.warned&&(i.warned=!0,(n=new Error("Possible EventEmitter memory leak detected. "+i.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit")).name="MaxListenersExceededWarning",n.emitter=e,n.type=t,n.count=i.length,s=n,console&&console.warn&&console.warn(s))),e}function u(e,t,s){e={fired:!1,wrapFn:void 0,target:e,type:t,listener:s},t=function(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}.bind(e);return t.listener=s,e.wrapFn=t}function _(e,t,s){e=e._events;if(void 0===e)return[];e=e[t];{if(void 0===e)return[];if("function"==typeof e)return s?[e.listener||e]:[e];if(s){for(var n=e,r=new Array(n.length),i=0;i<r.length;++i)r[i]=n[i].listener||n[i];return r}return p(e,e.length)}}function d(e){var t=this._events;if(void 0!==t){t=t[e];if("function"==typeof t)return 1;if(void 0!==t)return t.length}return 0}function p(e,t){for(var s=new Array(t),n=0;n<t;++n)s[n]=e[n];return s}function b(s,n,r,i){if("function"==typeof s.on)i.once?s.once(n,r):s.on(n,r);else{if("function"!=typeof s.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof s);s.addEventListener(n,function e(t){i.once&&s.removeEventListener(n,e),r(t)})}}Object.defineProperty(i,"defaultMaxListeners",{enumerable:!0,get:function(){return o},set:function(e){if("number"!=typeof e||e<0||r(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");o=e}}),i.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},i.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||r(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},i.prototype.getMaxListeners=function(){return c(this)},i.prototype.emit=function(e){for(var t=[],s=1;s<arguments.length;s++)t.push(arguments[s]);var n="error"===e,r=this._events;if(void 0!==r)n=n&&void 0===r.error;else if(!n)return!1;if(n){if((i=0<t.length?t[0]:i)instanceof Error)throw i;n=new Error("Unhandled error."+(i?" ("+i.message+")":""));throw n.context=i,n}var i=r[e];if(void 0===i)return!1;if("function"==typeof i)a(i,this,t);else for(var o=i.length,c=p(i,o),s=0;s<o;++s)a(c[s],this,t);return!0},i.prototype.on=i.prototype.addListener=function(e,t){return l(this,e,t,!1)},i.prototype.prependListener=function(e,t){return l(this,e,t,!0)},i.prototype.once=function(e,t){return h(t),this.on(e,u(this,e,t)),this},i.prototype.prependOnceListener=function(e,t){return h(t),this.prependListener(e,u(this,e,t)),this},i.prototype.off=i.prototype.removeListener=function(e,t){var s,n,r,i,o;if(h(t),void 0===(n=this._events))return this;if(void 0===(s=n[e]))return this;if(s===t||s.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete n[e],n.removeListener&&this.emit("removeListener",e,s.listener||t));else if("function"!=typeof s){for(r=-1,i=s.length-1;0<=i;i--)if(s[i]===t||s[i].listener===t){o=s[i].listener,r=i;break}if(r<0)return this;if(0===r)s.shift();else{var c=s;var a=r;for(;a+1<c.length;a++)c[a]=c[a+1];c.pop()}1===s.length&&(n[e]=s[0]),void 0!==n.removeListener&&this.emit("removeListener",e,o||t)}return this},i.prototype.removeAllListeners=function(e){var t,s=this._events;if(void 0===s)return this;if(void 0===s.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==s[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete s[e]),this;if(0===arguments.length){for(var n,r=Object.keys(s),i=0;i<r.length;++i)"removeListener"!==(n=r[i])&&this.removeAllListeners(n);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=s[e]))this.removeListener(e,t);else if(void 0!==t)for(i=t.length-1;0<=i;i--)this.removeListener(e,t[i]);return this},i.prototype.listeners=function(e){return _(this,e,!0)},i.prototype.rawListeners=function(e){return _(this,e,!1)},i.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):d.call(e,t)},i.prototype.listenerCount=d,i.prototype.eventNames=function(){return 0<this._eventsCount?n(this._events):[]}},()=>(t||e((t={exports:{}}).exports,t),t.exports)),m=p(f()),g=1,v=2,y=3,S=5,w=6,T=7,k=8,C=9,P=10,E=11,x=0,R=1,j=2,O=3,A=4,M=0,z=1,N=3,J=0,W=1,q=0,F=1;(s={}).Disconnected="disconnected",s.Connecting="connecting",s.Connected="connected",(n={}).Unsubscribed="unsubscribed",n.Subscribing="subscribing",n.Subscribed="subscribed";function L(e){return null!=e&&"function"==typeof e}function D(e,t,s){31<e&&(e=31);n=0,e=Math.min(s,t*Math.pow(2,e));var n,e=Math.floor(Math.random()*(e-n+1)+n);return Math.min(s,t+e)}function I(e){return Math.min(1e3*e,2147483647)}var B=class extends m.default{constructor(e,t,s){super(),this._resubscribeTimeout=null,this._refreshTimeout=null,this.channel=t,this.state="unsubscribed",this._centrifuge=e,this._token=null,this._getToken=null,this._data=null,this._recover=!1,this._offset=null,this._epoch=null,this._recoverable=!1,this._positioned=!1,this._joinLeave=!1,this._minResubscribeDelay=500,this._maxResubscribeDelay=2e4,this._resubscribeTimeout=null,this._resubscribeAttempts=0,this._promises={},this._promiseId=0,this._inflight=!1,this._refreshTimeout=null,this._setOptions(s),this._centrifuge._debugEnabled?(this.on("state",e=>{this._centrifuge._debug("subscription state",t,e.oldState,"->",e.newState)}),this.on("error",e=>{this._centrifuge._debug("subscription error",t,e)})):this.on("error",function(){Function.prototype()})}ready(n){return"unsubscribed"===this.state?Promise.reject({code:T,message:this.state}):"subscribed"===this.state?Promise.resolve():new Promise((e,t)=>{let s={resolve:e,reject:t};n&&(s.timeout=setTimeout(function(){t({code:g,message:"timeout"})},n)),this._promises[this._nextPromiseId()]=s})}subscribe(){this._isSubscribed()||(this._resubscribeAttempts=0,this._setSubscribing(J,"subscribe called"))}unsubscribe(){this._setUnsubscribed(q,"unsubscribe called",!0)}publish(e){let t=this;return this._methodCall().then(function(){return t._centrifuge.publish(t.channel,e)})}presence(){let e=this;return this._methodCall().then(function(){return e._centrifuge.presence(e.channel)})}presenceStats(){let e=this;return this._methodCall().then(function(){return e._centrifuge.presenceStats(e.channel)})}history(e){let t=this;return this._methodCall().then(function(){return t._centrifuge.history(t.channel,e)})}_methodCall(){return this._isSubscribed()?Promise.resolve():this._isUnsubscribed()?Promise.reject({code:T,message:this.state}):new Promise((e,t)=>{var s=setTimeout(function(){t({code:g,message:"timeout"})},this._centrifuge._config.timeout);this._promises[this._nextPromiseId()]={timeout:s,resolve:e,reject:t}})}_nextPromiseId(){return++this._promiseId}_needRecover(){return!0===this._recover}_isUnsubscribed(){return"unsubscribed"===this.state}_isSubscribing(){return"subscribing"===this.state}_isSubscribed(){return"subscribed"===this.state}_setState(e){var t;return this.state!==e&&(t=this.state,this.state=e,this.emit("state",{newState:e,oldState:t,channel:this.channel}),!0)}_usesToken(){return null!==this._token||null!==this._getToken}_clearSubscribingState(){this._resubscribeAttempts=0,this._clearResubscribeTimeout()}_clearSubscribedState(){this._clearRefreshTimeout()}_setSubscribed(t){if(this._isSubscribing()){this._clearSubscribingState(),t.recoverable&&(this._recover=!0,this._offset=t.offset||0,this._epoch=t.epoch||""),this._setState("subscribed");var s=this._centrifuge._getSubscribeContext(this.channel,t);this.emit("subscribed",s),this._resolvePromises();let e=t.publications;if(e&&0<e.length)for(var n in e)e.hasOwnProperty(n)&&this._handlePublication(e[n]);!0===t.expires&&(this._refreshTimeout=setTimeout(()=>this._refresh(),I(t.ttl)))}}_setSubscribing(e,t){this._isSubscribing()||(this._isSubscribed()&&this._clearSubscribedState(),this._setState("subscribing")&&this.emit("subscribing",{channel:this.channel,code:e,reason:t}),this._subscribe(!1,!1))}_subscribe(e,t){if(this._centrifuge._debug("subscribing on",this.channel),"connected"!==this._centrifuge.state&&!e)return this._centrifuge._debug("delay subscribe on",this.channel,"till connected"),null;if(this._usesToken()){if(this._token)return this._sendSubscribe(this._token,t);{if(e)return null;let t=this;return this._getSubscriptionToken().then(function(e){t._isSubscribing()&&(e?(t._token=e,t._sendSubscribe(e,!1)):t._failUnauthorized())}).catch(function(e){t._isSubscribing()&&(t.emit("error",{type:"subscribeToken",channel:t.channel,error:{code:k,message:void 0!==e?e.toString():""}}),t._scheduleResubscribe())}),null}}return this._sendSubscribe("",t)}_sendSubscribe(e,t){let s={channel:this.channel};e&&(s.token=e),this._data&&(s.data=this._data),this._positioned&&(s.positioned=!0),this._recoverable&&(s.recoverable=!0),this._joinLeave&&(s.join_leave=!0),this._needRecover()&&(s.recover=!0,(e=this._getOffset())&&(s.offset=e),(e=this._getEpoch())&&(s.epoch=e));e={subscribe:s};return this._inflight=!0,this._centrifuge._call(e,t).then(e=>{this._inflight=!1;var t=e.reply.subscribe;this._handleSubscribeResponse(t),e.next&&e.next()},e=>{this._inflight=!1,this._handleSubscribeError(e.error),e.next&&e.next()}),e}_handleSubscribeError(e){this._isSubscribing()&&(e.code===g?this._centrifuge._disconnect(O,"subscribe timeout",!0):this._subscribeError(e))}_handleSubscribeResponse(e){this._isSubscribing()&&this._setSubscribed(e)}_setUnsubscribed(e,t,s){this._isUnsubscribed()||(this._isSubscribed()&&(s&&this._centrifuge._unsubscribe(this),this._clearSubscribedState()),this._isSubscribing()&&this._clearSubscribingState(),this._setState("unsubscribed")&&this.emit("unsubscribed",{channel:this.channel,code:e,reason:t}),this._rejectPromises({code:T,message:this.state}))}_handlePublication(e){var t=this._centrifuge._getPublicationContext(this.channel,e);this.emit("publication",t),e.offset&&(this._offset=e.offset)}_handleJoin(e){e=this._centrifuge._getJoinLeaveContext(e.info);this.emit("join",{channel:this.channel,info:e})}_handleLeave(e){e=this._centrifuge._getJoinLeaveContext(e.info);this.emit("leave",{channel:this.channel,info:e})}_resolvePromises(){for(var e in this._promises)this._promises[e].timeout&&clearTimeout(this._promises[e].timeout),this._promises[e].resolve(),delete this._promises[e]}_rejectPromises(e){for(var t in this._promises)this._promises[t].timeout&&clearTimeout(this._promises[t].timeout),this._promises[t].reject(e),delete this._promises[t]}_scheduleResubscribe(){let e=this,t=this._getResubscribeDelay();this._resubscribeTimeout=setTimeout(function(){e._isSubscribing()&&e._subscribe(!1,!1)},t)}_subscribeError(e){var t;this._isSubscribing()&&(e.code<100||109===e.code||!0===e.temporary?(109===e.code&&(this._token=null),t={channel:this.channel,type:"subscribe",error:e},"connected"===this._centrifuge.state&&this.emit("error",t),this._scheduleResubscribe()):this._setUnsubscribed(e.code,e.message,!1))}_getResubscribeDelay(){var e=D(this._resubscribeAttempts,this._minResubscribeDelay,this._maxResubscribeDelay);return this._resubscribeAttempts++,e}_setOptions(e){e&&(e.since&&(this._offset=e.since.offset,this._epoch=e.since.epoch,this._recover=!0),e.data&&(this._data=e.data),void 0!==e.minResubscribeDelay&&(this._minResubscribeDelay=e.minResubscribeDelay),void 0!==e.maxResubscribeDelay&&(this._maxResubscribeDelay=e.maxResubscribeDelay),e.token&&(this._token=e.token),e.getToken&&(this._getToken=e.getToken),!0===e.positioned&&(this._positioned=!0),!0===e.recoverable&&(this._recoverable=!0),!0===e.joinLeave&&(this._joinLeave=!0))}_getOffset(){var e=this._offset;return null!==e?e:0}_getEpoch(){var e=this._epoch;return null!==e?e:""}_clearRefreshTimeout(){null!==this._refreshTimeout&&(clearTimeout(this._refreshTimeout),this._refreshTimeout=null)}_clearResubscribeTimeout(){null!==this._resubscribeTimeout&&(clearTimeout(this._resubscribeTimeout),this._resubscribeTimeout=null)}_getSubscriptionToken(){this._centrifuge._debug("get subscription token for channel",this.channel);let e={channel:this.channel},t=this._getToken;if(null===t)throw new Error("provide a function to get channel subscription token");return t(e)}_refresh(){this._clearRefreshTimeout();let s=this;this._getSubscriptionToken().then(function(e){s._isSubscribed()&&(e?(s._token=e,e={sub_refresh:{channel:s.channel,token:e}},s._centrifuge._call(e).then(e=>{var t=e.reply.sub_refresh;s._refreshResponse(t),e.next&&e.next()},e=>{s._refreshError(e.error),e.next&&e.next()})):s._failUnauthorized())}).catch(function(e){s.emit("error",{type:"refreshToken",channel:s.channel,error:{code:C,message:void 0!==e?e.toString():""}}),s._refreshTimeout=setTimeout(()=>s._refresh(),s._getRefreshRetryDelay())})}_refreshResponse(e){this._isSubscribed()&&(this._centrifuge._debug("subscription token refreshed, channel",this.channel),this._clearRefreshTimeout(),!0===e.expires&&(this._refreshTimeout=setTimeout(()=>this._refresh(),I(e.ttl))))}_refreshError(e){this._isSubscribed()&&(e.code<100||!0===e.temporary?(this.emit("error",{type:"refresh",channel:this.channel,error:e}),this._refreshTimeout=setTimeout(()=>this._refresh(),this._getRefreshRetryDelay())):this._setUnsubscribed(e.code,e.message,!0))}_getRefreshRetryDelay(){return D(0,1e4,2e4)}_failUnauthorized(){this._setUnsubscribed(F,"unauthorized",!0)}},H=class{constructor(e,t){this.endpoint=e,this.options=t,this._transport=null}name(){return"sockjs"}subName(){return"sockjs-"+this._transport.transport}emulation(){return!1}supported(){return null!==this.options.sockjs}initialize(e,t){this._transport=new this.options.sockjs(this.endpoint,null,this.options.sockjsOptions),this._transport.onopen=()=>{t.onOpen()},this._transport.onerror=e=>{t.onError(e)},this._transport.onclose=e=>{t.onClose(e)},this._transport.onmessage=e=>{t.onMessage(e.data)}}close(){this._transport.close()}send(e){this._transport.send(e)}},U=class{constructor(e,t){this.endpoint=e,this.options=t,this._transport=null}name(){return"websocket"}subName(){return"websocket"}emulation(){return!1}supported(){return void 0!==this.options.websocket&&null!==this.options.websocket}initialize(e,t){let s="protobuf"===e?"centrifuge-protobuf":"";""!==s?this._transport=new this.options.websocket(this.endpoint,s):this._transport=new this.options.websocket(this.endpoint),"protobuf"===e&&(this._transport.binaryType="arraybuffer"),this._transport.onopen=()=>{t.onOpen()},this._transport.onerror=e=>{t.onError(e)},this._transport.onclose=e=>{t.onClose(e)},this._transport.onmessage=e=>{t.onMessage(e.data)}}close(){this._transport.close()}send(e){this._transport.send(e)}},K=class{constructor(e,t){this.endpoint=e,this.options=t,this._abortController=null,this._utf8decoder=new TextDecoder,this._protocol="json"}name(){return"http_stream"}subName(){return"http_stream"}emulation(){return!0}_handleErrors(e){if(e.ok)return e;throw new Error(e.status)}_fetchEventTarget(l,e,t){let u=new EventTarget;return l.options.fetch(e,t).then(l._handleErrors).then(e=>{u.dispatchEvent(new Event("open"));let c="",a=0,h=new Uint8Array,t=e.body.getReader();return new l.options.readableStream({start(o){return function i(){return t.read().then(({done:e,value:t})=>{if(e)return u.dispatchEvent(new Event("close")),void o.close();try{if("json"===l._protocol)for(c+=l._utf8decoder.decode(t);a<c.length;){var s;c[a]===`
`?(s=c.substring(0,a),u.dispatchEvent(new MessageEvent("message",{data:s})),c=c.substring(a+1),a=0):++a}else{let e=new Uint8Array(h.length+t.length);for(e.set(h),e.set(t,h.length),h=e;;){var n=l.options.decoder.decodeReply(h);if(!n.ok)break;var r=h.slice(0,n.pos);u.dispatchEvent(new MessageEvent("message",{data:r})),h=h.slice(n.pos)}}}catch(e){return u.dispatchEvent(new Event("error",{detail:e})),u.dispatchEvent(new Event("close")),void o.close()}i()}).catch(function(e){u.dispatchEvent(new Event("error",{detail:e})),u.dispatchEvent(new Event("close")),o.close()})}()}})}).catch(e=>{u.dispatchEvent(new Event("error",{detail:e})),u.dispatchEvent(new Event("close"))}),u}supported(){return null!==this.options.fetch&&null!==this.options.readableStream&&"undefined"!=typeof TextDecoder&&"undefined"!=typeof AbortController&&"undefined"!=typeof EventTarget&&"undefined"!=typeof Event&&"undefined"!=typeof MessageEvent&&"undefined"!=typeof Error}initialize(e,t,s){this._protocol=e,this._abortController=new AbortController;let n,r,i=(r=s,{method:"POST",headers:n="json"===e?{Accept:"application/json","Content-Type":"application/json"}:{Accept:"application/octet-stream","Content-Type":"application/octet-stream"},body:r,mode:"cors",credentials:"same-origin",cache:"no-cache",signal:this._abortController.signal}),o=this._fetchEventTarget(this,this.endpoint,i);o.addEventListener("open",()=>{t.onOpen()}),o.addEventListener("error",e=>{this._abortController.abort(),t.onError(e)}),o.addEventListener("close",()=>{this._abortController.abort(),t.onClose({code:4,reason:"connection closed"})}),o.addEventListener("message",e=>{t.onMessage(e.data)})}close(){this._abortController.abort()}send(e,t,s){let n,r,i={session:t,node:s,data:e},o=(r="json"===this._protocol?(n={"Content-Type":"application/json"},JSON.stringify(i)):(n={"Content-Type":"application/octet-stream"},this.options.encoder.encodeEmulationRequest(i)),this.options.fetch),c={method:"POST",headers:n,body:r,mode:"cors",credentials:"same-origin",cache:"no-cache"};o(this.options.emulationEndpoint,c)}},G=class{constructor(e,t){this.endpoint=e,this.options=t,this._protocol="json",this._transport=null,this._onClose=null}name(){return"sse"}subName(){return"sse"}emulation(){return!0}supported(){return null!==this.options.eventsource&&null!==this.options.fetch}initialize(e,t,s){let n,r=((n=globalThis&&globalThis.document&&globalThis.document.baseURI?new URL(this.endpoint,globalThis.document.baseURI):new URL(this.endpoint)).searchParams.append("cf_connect",s),new this.options.eventsource(n.toString(),{}));this._transport=r;r.onopen=function(){t.onOpen()},r.onerror=function(e){r.close(),t.onError(e),t.onClose({code:4,reason:"connection closed"})},r.onmessage=function(e){t.onMessage(e.data)},this._onClose=function(){t.onClose({code:4,reason:"connection closed"})}}close(){this._transport.close(),null!==this._onClose&&this._onClose()}send(e,t,s){let n={session:t,node:s,data:e},r=JSON.stringify(n),i=this.options.fetch,o={method:"POST",headers:{"Content-Type":"application/json"},body:r,mode:"cors",credentials:"same-origin",cache:"no-cache"};i(this.options.emulationEndpoint,o)}},Q=class{constructor(e,t){this.endpoint=e,this.options=t,this._transport=null,this._stream=null,this._writer=null,this._utf8decoder=new TextDecoder,this._protocol="json"}name(){return"webtransport"}subName(){return"webtransport"}emulation(){return!1}supported(){return void 0!==this.options.webtransport&&null!==this.options.webtransport}initialize(n,r){return b(this,null,function*(){let e,t=(e=globalThis&&globalThis.document&&globalThis.document.baseURI?new URL(this.endpoint,globalThis.document.baseURI):new URL(this.endpoint),"protobuf"===n&&e.searchParams.append("cf_protocol","protobuf"),this._protocol=n,new EventTarget);this._transport=new this.options.webtransport(e.toString()),this._transport.closed.then(()=>{r.onClose({code:4,reason:"connection closed"})}).catch(()=>{r.onClose({code:4,reason:"connection closed"})});try{yield this._transport.ready}catch(e){return void this.close()}let s;try{s=yield this._transport.createBidirectionalStream()}catch(e){return void this.close()}this._stream=s,this._writer=this._stream.writable.getWriter(),t.addEventListener("close",()=>{r.onClose({code:4,reason:"connection closed"})}),t.addEventListener("message",e=>{r.onMessage(e.data)}),this._startReading(t),r.onOpen()})}_startReading(h){return b(this,null,function*(){let e=this._stream.readable.getReader(),t="",s=0,n=new Uint8Array;try{for(;;){var r,{done:i,value:o}=yield e.read();if(0<o.length)if("json"===this._protocol)for(t+=this._utf8decoder.decode(o);s<t.length;)t[s]===`
`?(r=t.substring(0,s),h.dispatchEvent(new MessageEvent("message",{data:r})),t=t.substring(s+1),s=0):++s;else{let e=new Uint8Array(n.length+o.length);for(e.set(n),e.set(o,n.length),n=e;;){var c=this.options.decoder.decodeReply(n);if(!c.ok)break;var a=n.slice(0,c.pos);h.dispatchEvent(new MessageEvent("message",{data:a})),n=n.slice(c.pos)}}if(i)break}}catch(e){h.dispatchEvent(new Event("close"))}})}close(){return b(this,null,function*(){try{this._writer&&(yield this._writer.close()),this._transport.close()}catch(e){}})}send(t){return b(this,null,function*(){let e;e="json"===this._protocol?(new TextEncoder).encode(t+`
`):t;try{yield this._writer.write(e)}catch(e){this.close()}})}},V=class{encodeCommands(e){return e.map(e=>JSON.stringify(e)).join(`
`)}},X=class{decodeReplies(e){return e.trim().split(`
`).map(e=>JSON.parse(e))}},m=p(f()),Y={protocol:"json",token:null,getToken:null,data:null,debug:!1,name:"js",version:"",fetch:null,readableStream:null,websocket:null,eventsource:null,sockjs:null,sockjsOptions:{},emulationEndpoint:"/emulation",minReconnectDelay:500,maxReconnectDelay:2e4,timeout:5e3,maxServerPingDelay:1e4},p=class extends m.default{constructor(e,t){super(),this._reconnectTimeout=null,this._refreshTimeout=null,this._serverPingTimeout=null,this.state="disconnected",this._endpoint=e,this._emulation=!1,this._transports=[],this._currentTransportIndex=0,this._triedAllTransports=!1,this._transportWasOpen=!1,this._transport=null,this._transportClosed=!0,this._encoder=null,this._decoder=null,this._reconnectTimeout=null,this._reconnectAttempts=0,this._client=null,this._session="",this._node="",this._subs={},this._serverSubs={},this._commandId=0,this._commands=[],this._batching=!1,this._refreshRequired=!1,this._refreshTimeout=null,this._callbacks={},this._token=void 0,this._dispatchPromise=Promise.resolve(),this._serverPing=0,this._serverPingTimeout=null,this._sendPong=!1,this._promises={},this._promiseId=0,this._debugEnabled=!1,this._config=d(d({},Y),t),this._configure(),this._debugEnabled?(this.on("state",e=>{this._debug("client state",e.oldState,"->",e.newState)}),this.on("error",e=>{this._debug("client error",e)})):this.on("error",function(){Function.prototype()})}newSubscription(e,t){if(null!==this.getSubscription(e))throw new Error("Subscription to the channel "+e+" already exists");t=new B(this,e,t);return this._subs[e]=t}getSubscription(e){return this._getSub(e)}removeSubscription(e){e&&("unsubscribed"!==e.state&&e.unsubscribe(),this._removeSubscription(e))}subscriptions(){return this._subs}ready(n){return"disconnected"===this.state?Promise.reject({code:y,message:"client disconnected"}):"connected"===this.state?Promise.resolve():new Promise((e,t)=>{let s={resolve:e,reject:t};n&&(s.timeout=setTimeout(function(){t({code:g,message:"timeout"})},n)),this._promises[this._nextPromiseId()]=s})}connect(){this._isConnected()?this._debug("connect called when already connected"):this._isConnecting()?this._debug("connect called when already connecting"):(this._reconnectAttempts=0,this._startConnecting())}disconnect(){this._disconnect(M,"disconnect called",!1)}send(e){let t={send:{data:e}},s=this;return this._methodCall().then(function(){return s._transportSendCommands([t])?Promise.resolve():Promise.reject(s._createErrorObject(P,"transport write error"))})}rpc(e,t){let s={rpc:{method:e,data:t}},n=this;return this._methodCall().then(function(){return n._callPromise(s,function(e){return{data:e.rpc.data}})})}publish(e,t){let s={publish:{channel:e,data:t}},n=this;return this._methodCall().then(function(){return n._callPromise(s,function(){return{}})})}history(n,e){let t={history:this._getHistoryRequest(n,e)},r=this;return this._methodCall().then(function(){return r._callPromise(t,function(e){let t=e.history,s=[];if(t.publications)for(let e=0;e<t.publications.length;e++)s.push(r._getPublicationContext(n,t.publications[e]));return{publications:s,epoch:t.epoch||"",offset:t.offset||0}})})}presence(e){let t={presence:{channel:e}},s=this;return this._methodCall().then(function(){return s._callPromise(t,function(e){return{clients:e.presence.presence}})})}presenceStats(e){let t={presence_stats:{channel:e}},s=this;return this._methodCall().then(function(){return s._callPromise(t,function(e){e=e.presence_stats;return{numUsers:e.num_users,numClients:e.num_clients}})})}startBatching(){this._batching=!0}stopBatching(){let e=this;Promise.resolve().then(function(){Promise.resolve().then(function(){e._batching=!1,e._flush()})})}_debug(...t){if(this._debugEnabled){var s="debug";if(globalThis.console){let e=globalThis.console[s];L(e)&&e.apply(globalThis.console,t)}}}_setFormat(e){if(!this._formatOverride(e)){if("protobuf"===e)throw new Error("not implemented by JSON-only Centrifuge client, use client with Protobuf support");this._encoder=new V,this._decoder=new X}}_formatOverride(e){return!1}_configure(){if(!("Promise"in globalThis))throw new Error("Promise polyfill required");if(!this._endpoint)throw new Error("endpoint configuration required");if("json"!==this._config.protocol&&"protobuf"!==this._config.protocol)throw new Error("unsupported protocol "+this._config.protocol);if(null!==this._config.token&&(this._token=this._config.token),this._setFormat("json"),"protobuf"===this._config.protocol&&this._setFormat("protobuf"),(!0===this._config.debug||"undefined"!=typeof localStorage&&localStorage.getItem("centrifuge.debug"))&&(this._debugEnabled=!0),this._debug("config",this._config),"string"!=typeof this._endpoint){if(!("object"==typeof this._endpoint&&this._endpoint instanceof Array))throw new Error("unsupported url configuration type: only string or array of objects are supported");for(var e in this._transports=this._endpoint,this._emulation=!0,this._transports){e=this._transports[e];if(!e.endpoint||!e.transport)throw new Error("malformed transport configuration");e=e.transport;if(["websocket","http_stream","sse","sockjs","webtransport"].indexOf(e)<0)throw new Error("unsupported transport name: "+e)}}}_setState(e){var t;return this.state!==e&&(t=this.state,this.state=e,this.emit("state",{newState:e,oldState:t}),!0)}_isDisconnected(){return"disconnected"===this.state}_isConnecting(){return"connecting"===this.state}_isConnected(){return"connected"===this.state}_nextCommandId(){return++this._commandId}_getReconnectDelay(){var e=D(this._reconnectAttempts,this._config.minReconnectDelay,this._config.maxReconnectDelay);return this._reconnectAttempts+=1,e}_clearOutgoingRequests(){for(var t in this._callbacks)if(this._callbacks.hasOwnProperty(t)){t=this._callbacks[t];clearTimeout(t.timeout);let e=t.errback;if(!e)continue;e({error:this._createErrorObject(E,"connection closed")})}this._callbacks={}}_clearConnectedState(){for(var t in this._client=null,this._clearServerPingTimeout(),this._clearRefreshTimeout(),this._subs)if(this._subs.hasOwnProperty(t)){let e=this._subs[t];"subscribed"===e.state&&e._setSubscribing(W,"transport closed")}for(var e in this._serverSubs)this._serverSubs.hasOwnProperty(e)&&this.emit("subscribing",{channel:e})}_handleWriteError(e){for(var t of e){t=t.id;if(t in this._callbacks){let e=this._callbacks[t];clearTimeout(this._callbacks[t].timeout),delete this._callbacks[t],e.errback({error:this._createErrorObject(P,"transport write error")})}}}_transportSendCommands(t){if(!t.length)return!0;if(!this._transport)return!1;try{this._transport.send(this._encoder.encodeCommands(t),this._session,this._node)}catch(e){return this._debug("error writing commands",e),this._handleWriteError(t),!1}return!0}_initializeTransport(){let t,s=(null!==this._config.websocket?t=this._config.websocket:"function"!=typeof globalThis.WebSocket&&"object"!=typeof globalThis.WebSocket||(t=globalThis.WebSocket),null),n=(null!==this._config.sockjs?s=this._config.sockjs:void 0!==globalThis.SockJS&&(s=globalThis.SockJS),null),r=(null!==this._config.eventsource?n=this._config.eventsource:void 0!==globalThis.EventSource&&(n=globalThis.EventSource),null),i=(null!==this._config.fetch?r=this._config.fetch:void 0!==globalThis.fetch&&(r=globalThis.fetch),null);if(null!==this._config.readableStream?i=this._config.readableStream:void 0!==globalThis.ReadableStream&&(i=globalThis.ReadableStream),this._emulation){this._currentTransportIndex>=this._transports.length&&(this._triedAllTransports=!0,this._currentTransportIndex=0);let e=0;for(;;){if(e>=this._transports.length)throw new Error("no supported transport found");var o=this._transports[this._currentTransportIndex],c=o.transport,o=o.endpoint;if("websocket"===c){if(this._debug("trying websocket transport"),this._transport=new U(o,{websocket:t}),!this._transport.supported()){this._debug("websocket transport not available"),this._currentTransportIndex++,e++;continue}}else if("webtransport"===c){if(this._debug("trying webtransport transport"),this._transport=new Q(o,{webtransport:globalThis.WebTransport,decoder:this._decoder,encoder:this._encoder}),!this._transport.supported()){this._debug("webtransport transport not available"),this._currentTransportIndex++,e++;continue}}else if("http_stream"===c){if(this._debug("trying http_stream transport"),this._transport=new K(o,{fetch:r,readableStream:i,emulationEndpoint:this._config.emulationEndpoint,decoder:this._decoder,encoder:this._encoder}),!this._transport.supported()){this._debug("http_stream transport not available"),this._currentTransportIndex++,e++;continue}}else if("sse"===c){if(this._debug("trying sse transport"),this._transport=new G(o,{eventsource:n,fetch:r,emulationEndpoint:this._config.emulationEndpoint}),!this._transport.supported()){this._debug("sse transport not available"),this._currentTransportIndex++,e++;continue}}else{if("sockjs"!==c)throw new Error("unknown transport "+c);if(this._debug("trying sockjs"),this._transport=new H(o,{sockjs:s,sockjsOptions:this._config.sockjsOptions}),!this._transport.supported()){this._debug("sockjs transport not available"),this._currentTransportIndex++,e++;continue}}break}}else{if(_=this._endpoint,b="http",0===_.lastIndexOf(b,0))throw new Error("Provide explicit transport endpoints configuration in case of using HTTP (i.e. using array of TransportEndpoint instead of a single string), or use ws(s):// scheme in an endpoint if you aimed using WebSocket transport");if(this._debug("client will use websocket"),this._transport=new U(this._endpoint,{websocket:t}),!this._transport.supported())throw new Error("WebSocket not available")}let a=this,e,h=!1,l=!0,u=("sse"===this._transport.name()&&(l=!1),[]);if(this._transport.emulation()){var _=a._sendConnect(!0);if(u.push(_),l){var d,p=a._sendSubscribeCommands(!0,!0);for(d in p)u.push(p[d])}}var b=this._encoder.encodeCommands(u);this._transport.initialize(this._config.protocol,{onOpen:function(){h=!0,e=a._transport.subName(),a._debug(e,"transport open"),a._transportWasOpen=!0,a._transportClosed=!1,a._transport.emulation()||(a.startBatching(),a._sendConnect(!1),l&&a._sendSubscribeCommands(!0,!1),a.stopBatching())},onError:function(e){a._debug("transport level error",e)},onClose:function(t){a._debug(a._transport.name(),"transport closed");let s="connection closed",n=a._transportClosed=!0,r=0;if(t&&"code"in t&&t.code&&(r=t.code),t&&t.reason)try{var e=JSON.parse(t.reason);s=e.reason,n=e.reconnect}catch(e){s=t.reason,(3500<=r&&r<4e3||4500<=r&&r<5e3)&&(n=!1)}r<3e3?(1009===r?(r=N,s="message size limit exceeded",n=!1):(r=R,s="transport closed"),a._emulation&&!a._transportWasOpen&&(a._currentTransportIndex++,a._currentTransportIndex>=a._transports.length&&(a._triedAllTransports=!0,a._currentTransportIndex=0))):a._transportWasOpen=!0;let i=!1;if(!a._emulation||a._transportWasOpen||a._triedAllTransports||(i=!0),a._isConnecting()&&!h&&a.emit("error",{type:"transport",error:{code:v,message:"transport closed"},transport:a._transport.name()}),a._disconnect(r,s,n),a._isConnecting()){let e=a._getReconnectDelay();i&&(e=0),a._debug("reconnect after "+e+" milliseconds"),a._reconnectTimeout=setTimeout(()=>{a._startReconnecting()},e)}},onMessage:function(e){a._dataReceived(e)}},b)}_sendConnect(e){let t=this._constructConnectCommand(),s=this;return this._call(t,e).then(e=>{var t=e.reply.connect;s._connectResponse(t),e.next&&e.next()},e=>{s._connectError(e.error),e.next&&e.next()}),t}_startReconnecting(){if(this._isConnecting())if(this._refreshRequired||!this._token&&null!==this._config.getToken){let s=this;this._getToken().then(function(e){s._isConnecting()&&(e?(s._token=e,s._debug("connection token refreshed"),s._initializeTransport()):s._failUnauthorized())}).catch(function(e){var t;s._isConnecting()&&(s.emit("error",{type:"connectToken",error:{code:S,message:void 0!==e?e.toString():""}}),t=s._getReconnectDelay(),s._debug("error on connection token refresh, reconnect after "+t+" milliseconds",e),s._reconnectTimeout=setTimeout(()=>{s._startReconnecting()},t))})}else this._initializeTransport()}_connectError(e){"connecting"===this.state&&(109===e.code&&(this._refreshRequired=!0),e.code<100||!0===e.temporary||109===e.code?(this.emit("error",{type:"connect",error:e}),this._transport&&!this._transportClosed&&(this._transportClosed=!0,this._transport.close())):this._disconnect(e.code,e.message,!1))}_constructConnectCommand(){let e={},t=(this._token&&(e.token=this._token),this._config.data&&(e.data=this._config.data),this._config.name&&(e.name=this._config.name),this._config.version&&(e.version=this._config.version),{}),s=!1;for(var n in this._serverSubs)if(this._serverSubs.hasOwnProperty(n)&&this._serverSubs[n].recoverable){let e={recover:s=!0};this._serverSubs[n].offset&&(e.offset=this._serverSubs[n].offset),this._serverSubs[n].epoch&&(e.epoch=this._serverSubs[n].epoch),t[n]=e}return s&&(e.subs=t),{connect:e}}_getHistoryRequest(e,t){let s={channel:e};return void 0!==t&&(t.since&&(s.since={offset:t.since.offset},t.since.epoch&&(s.since.epoch=t.since.epoch)),void 0!==t.limit&&(s.limit=t.limit),!0===t.reverse&&(s.reverse=!0)),s}_methodCall(){return this._isConnected()?Promise.resolve():new Promise((e,t)=>{var s=setTimeout(function(){t({code:g,message:"timeout"})},this._config.timeout);this._promises[this._nextPromiseId()]={timeout:s,resolve:e,reject:t}})}_callPromise(e,n){return new Promise((t,s)=>{this._call(e,!1).then(e=>{t(n(e.reply)),e.next&&e.next()},e=>{s(e.error),e.next&&e.next()})})}_dataReceived(e){0<this._serverPing&&this._waitServerPing();let s=this._decoder.decodeReplies(e);this._dispatchPromise=this._dispatchPromise.then(()=>{let t;this._dispatchPromise=new Promise(e=>{t=e}),this._dispatchSynchronized(s,t)})}_dispatchSynchronized(t,e){let s=Promise.resolve();for(let e in t)t.hasOwnProperty(e)&&(s=s.then(()=>this._dispatchReply(t[e])));s=s.then(()=>{e()})}_dispatchReply(e){let t,s=new Promise(e=>{t=e});if(null==e)return this._debug("dispatch: got undefined or null reply"),t(),s;var n=e.id;return n&&0<n?this._handleReply(e,t):e.push?this._handlePush(e.push,t):this._handleServerPing(t),s}_call(s,n){return new Promise((e,t)=>{s.id=this._nextCommandId(),this._registerCall(s.id,e,t),n||this._addCommand(s)})}_startConnecting(){this._debug("start connecting"),this._setState("connecting")&&this.emit("connecting",{code:x,reason:"connect called"}),this._client=null,this._startReconnecting()}_disconnect(n,r,i){if(!this._isDisconnected()){let e=this.state,t={code:n,reason:r},s=!1;i?s=this._setState("connecting"):(s=this._setState("disconnected"),this._rejectPromises({code:y,message:"disconnected"})),this._clearOutgoingRequests(),"connecting"===e&&this._clearReconnectTimeout(),"connected"===e&&this._clearConnectedState(),s&&(this._isConnecting()?this.emit("connecting",t):this.emit("disconnected",t)),this._transport&&!this._transportClosed&&(this._transportClosed=!0,this._transport.close())}}_failUnauthorized(){this._disconnect(z,"unauthorized",!1)}_getToken(){if(this._debug("get connection token"),this._config.getToken)return this._config.getToken({});throw new Error("provide a function to get connection token")}_refresh(){let t=this._client,s=this;this._getToken().then(function(e){t===s._client&&(e?(s._token=e,s._debug("connection token refreshed"),s._isConnected()&&(e={refresh:{token:s._token}},s._call(e,!1).then(e=>{var t=e.reply.refresh;s._refreshResponse(t),e.next&&e.next()},e=>{s._refreshError(e.error),e.next&&e.next()}))):s._failUnauthorized())}).catch(function(e){s.emit("error",{type:"refreshToken",error:{code:w,message:void 0!==e?e.toString():""}}),s._refreshTimeout=setTimeout(()=>s._refresh(),s._getRefreshRetryDelay())})}_refreshError(e){e.code<100||!0===e.temporary?(this.emit("error",{type:"refresh",error:e}),this._refreshTimeout=setTimeout(()=>this._refresh(),this._getRefreshRetryDelay())):this._disconnect(e.code,e.message,!1)}_getRefreshRetryDelay(){return D(0,5e3,1e4)}_refreshResponse(e){this._refreshTimeout&&(clearTimeout(this._refreshTimeout),this._refreshTimeout=null),e.expires&&(this._client=e.client,this._refreshTimeout=setTimeout(()=>this._refresh(),I(e.ttl)))}_removeSubscription(e){null!==e&&delete this._subs[e.channel]}_unsubscribe(s){if(this._isConnected()){let e={unsubscribe:{channel:s.channel}},t=this;this._call(e,!1).then(e=>{e.next&&e.next()},e=>{e.next&&e.next(),t._disconnect(A,"unsubscribe error",!0)})}}_getSub(e){return this._subs[e]||null}_isServerSub(e){return void 0!==this._serverSubs[e]}_sendSubscribeCommands(t,s){let n=[];for(var r in this._subs)if(this._subs.hasOwnProperty(r)){let e=this._subs[r];!0===e._inflight||"subscribing"!==e.state||(r=e._subscribe(t,s))&&n.push(r)}return n}_connectResponse(t){if(this._transportWasOpen=!0,this._reconnectAttempts=0,this._refreshRequired=!1,!this._isConnected()){this._client=t.client,this._setState("connected"),this._refreshTimeout&&clearTimeout(this._refreshTimeout),t.expires&&(this._refreshTimeout=setTimeout(()=>this._refresh(),I(t.ttl))),this._session=t.session,this._node=t.node,this.startBatching(),this._sendSubscribeCommands(!1,!1),this.stopBatching();let e={client:t.client,transport:this._transport.subName()};t.data&&(e.data=t.data),this.emit("connected",e),this._resolvePromises(),this._processServerSubs(t.subs||{}),t.ping&&0<t.ping?(this._serverPing=1e3*t.ping,this._sendPong=!0===t.pong,this._waitServerPing()):this._serverPing=0}}_processServerSubs(e){for(var t in e){var s;e.hasOwnProperty(t)&&(s=e[t],this._serverSubs[t]={offset:s.offset,epoch:s.epoch,recoverable:s.recoverable||!1},t=this._getSubscribeContext(t,s),this.emit("subscribed",t))}for(var n in e)if(e.hasOwnProperty(n)){var r=e[n];if(r.recovered){let e=r.publications;if(e&&0<e.length)for(var i in e)e.hasOwnProperty(i)&&this._handlePublication(n,e[i])}}for(var o in this._serverSubs)this._serverSubs.hasOwnProperty(o)&&!e[o]&&(this.emit("unsubscribed",{channel:o}),delete this._serverSubs[o])}_clearRefreshTimeout(){null!==this._refreshTimeout&&(clearTimeout(this._refreshTimeout),this._refreshTimeout=null)}_clearReconnectTimeout(){null!==this._reconnectTimeout&&(clearTimeout(this._reconnectTimeout),this._reconnectTimeout=null)}_clearServerPingTimeout(){null!==this._serverPingTimeout&&(clearTimeout(this._serverPingTimeout),this._serverPingTimeout=null)}_waitServerPing(){0===this._config.maxServerPingDelay||this._isConnected()&&(this._clearServerPingTimeout(),this._serverPingTimeout=setTimeout(()=>{this._isConnected()&&this._disconnect(j,"no ping",!0)},this._serverPing+this._config.maxServerPingDelay))}_getSubscribeContext(e,t){let s={channel:e,positioned:!1,recoverable:!1,wasRecovering:!1,recovered:!1},n=(t.recovered&&(s.recovered=!0),t.positioned&&(s.positioned=!0),t.recoverable&&(s.recoverable=!0),t.was_recovering&&(s.wasRecovering=!0),""),r=("epoch"in t&&(n=t.epoch),0);return"offset"in t&&(r=t.offset),(s.positioned||s.recoverable)&&(s.streamPosition={offset:r,epoch:n}),t.data&&(s.data=t.data),s}_handleReply(t,s){var n=t.id;if(n in this._callbacks){var r=this._callbacks[n];if(clearTimeout(this._callbacks[n].timeout),delete this._callbacks[n],"error"in(n=t)&&null!==n.error){let e=r.errback;e?(n=t.error,e({error:n,next:s})):s()}else{let e=r.callback;e&&e({reply:t,next:s})}}else s()}_handleJoin(e,t){let s=this._getSub(e);s?s._handleJoin(t):this._isServerSub(e)&&(e={channel:e,info:this._getJoinLeaveContext(t.info)},this.emit("join",e))}_handleLeave(e,t){let s=this._getSub(e);s?s._handleLeave(t):this._isServerSub(e)&&(e={channel:e,info:this._getJoinLeaveContext(t.info)},this.emit("leave",e))}_handleUnsubscribe(e,t){let s=this._getSub(e);s?t.code<2500?s._setUnsubscribed(t.code,t.reason,!1):s._setSubscribing(t.code,t.reason):this._isServerSub(e)&&(delete this._serverSubs[e],this.emit("unsubscribed",{channel:e}))}_handleSubscribe(e,t){this._serverSubs[e]={offset:t.offset,epoch:t.epoch,recoverable:t.recoverable||!1},this.emit("subscribed",this._getSubscribeContext(e,t))}_handleDisconnect(e){let t=e.code,s=3500<=t&&t<4e3||4500<=t&&t<5e3?!1:!0;this._disconnect(t,e.reason,s)}_getPublicationContext(e,t){let s={channel:e,data:t.data};return t.offset&&(s.offset=t.offset),t.info&&(s.info=this._getJoinLeaveContext(t.info)),t.tags&&(s.tags=t.tags),s}_getJoinLeaveContext(e){let t={client:e.client,user:e.user};return e.conn_info&&(t.connInfo=e.conn_info),e.chan_info&&(t.chanInfo=e.chan_info),t}_handlePublication(e,t){let s=this._getSub(e);var n;s?s._handlePublication(t):this._isServerSub(e)&&(n=this._getPublicationContext(e,t),this.emit("publication",n),void 0!==t.offset&&(this._serverSubs[e].offset=t.offset))}_handleMessage(e){this.emit("message",{data:e.data})}_handleServerPing(e){this._sendPong&&this._transportSendCommands([{}]),e()}_handlePush(e,t){var s=e.channel;e.pub?this._handlePublication(s,e.pub):e.message?this._handleMessage(e.message):e.join?this._handleJoin(s,e.join):e.leave?this._handleLeave(s,e.leave):e.unsubscribe?this._handleUnsubscribe(s,e.unsubscribe):e.subscribe?this._handleSubscribe(s,e.subscribe):e.disconnect&&this._handleDisconnect(e.disconnect),t()}_flush(){var e=this._commands.slice(0);this._commands=[],this._transportSendCommands(e)}_createErrorObject(e,t,s){let n={code:e,message:t};return s&&(n.temporary=!0),n}_registerCall(e,t,s){this._callbacks[e]={callback:t,errback:s,timeout:null},this._callbacks[e].timeout=setTimeout(()=>{delete this._callbacks[e],L(s)&&s({error:this._createErrorObject(g,"timeout")})},this._config.timeout)}_addCommand(e){this._batching?this._commands.push(e):this._transportSendCommands([e])}_nextPromiseId(){return++this._promiseId}_resolvePromises(){for(var e in this._promises)this._promises[e].timeout&&clearTimeout(this._promises[e].timeout),this._promises[e].resolve(),delete this._promises[e]}_rejectPromises(e){for(var t in this._promises)this._promises[t].timeout&&clearTimeout(this._promises[t].timeout),this._promises[t].reject(e),delete this._promises[t]}};p.SubscriptionState=n,p.State=s,window.Centrifuge=p})();